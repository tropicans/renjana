// Prisma Schema — Renjana LMS Phase 2
// Docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── Enums ────────────────────────────────────────────────────────────────────

enum Role {
  LEARNER
  INSTRUCTOR
  ADMIN
  MANAGER
  FINANCE
}

enum CourseStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum EnrollmentStatus {
  ACTIVE
  COMPLETED
  DROPPED
}

// ─── Models ───────────────────────────────────────────────────────────────────

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String   @map("password_hash")
  fullName     String   @map("full_name")
  role         Role     @default(LEARNER)
  avatarUrl    String?  @map("avatar_url")
  phone        String?
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  enrollments  Enrollment[]
  attendances  Attendance[]
  evidences    Evidence[]
  certificates Certificate[]
  auditLogs    AuditLog[]

  @@map("users")
}

model Course {
  id          String       @id @default(uuid())
  title       String
  description String?
  thumbnail   String?
  status      CourseStatus @default(DRAFT)
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  // Relations
  modules     Module[]
  enrollments Enrollment[]

  @@map("courses")
}

model Module {
  id        String   @id @default(uuid())
  courseId  String   @map("course_id")
  title     String
  order     Int
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons   Lesson[]

  @@map("modules")
}

model Lesson {
  id          String   @id @default(uuid())
  moduleId    String   @map("module_id")
  title       String
  type        String   @default("VIDEO") // VIDEO, QUIZ, READING, ASSIGNMENT
  contentUrl  String?  @map("content_url")
  durationMin Int?     @map("duration_min")
  order       Int
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  module      Module     @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  progresses  Progress[]
  attendances Attendance[]

  @@map("lessons")
}

model Enrollment {
  id                   String           @id @default(uuid())
  userId               String           @map("user_id")
  courseId             String           @map("course_id")
  status               EnrollmentStatus @default(ACTIVE)
  completionPercentage Float            @default(0) @map("completion_percentage")
  enrolledAt           DateTime         @default(now()) @map("enrolled_at")
  completedAt          DateTime?        @map("completed_at")

  // Relations
  user        User         @relation(fields: [userId], references: [id])
  course      Course       @relation(fields: [courseId], references: [id])
  progresses  Progress[]
  certificate Certificate?

  @@unique([userId, courseId])
  @@map("enrollments")
}

model Progress {
  id           String    @id @default(uuid())
  enrollmentId String    @map("enrollment_id")
  lessonId     String    @map("lesson_id")
  isCompleted  Boolean   @default(false) @map("is_completed")
  score        Int?
  completedAt  DateTime? @map("completed_at")

  // Relations
  enrollment   Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  lesson       Lesson     @relation(fields: [lessonId], references: [id])

  @@unique([enrollmentId, lessonId])
  @@map("progresses")
}

model Attendance {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  lessonId   String   @map("lesson_id")
  checkedAt  DateTime @default(now()) @map("checked_at")
  latitude   Float?
  longitude  Float?
  notes      String?

  // Relations
  user   User   @relation(fields: [userId], references: [id])
  lesson Lesson @relation(fields: [lessonId], references: [id])

  @@map("attendances")
}

model Evidence {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  title       String
  fileUrl     String   @map("file_url")
  fileType    String   @map("file_type") // image, pdf
  uploadedAt  DateTime @default(now()) @map("uploaded_at")

  // Relations
  user        User     @relation(fields: [userId], references: [id])

  @@map("evidences")
}

model Certificate {
  id           String    @id @default(uuid())
  enrollmentId String    @unique @map("enrollment_id")
  userId       String    @map("user_id")
  pdfUrl       String?   @map("pdf_url")
  issuedAt     DateTime  @default(now()) @map("issued_at")

  // Relations
  enrollment   Enrollment @relation(fields: [enrollmentId], references: [id])
  user         User       @relation(fields: [userId], references: [id])

  @@map("certificates")
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  action    String
  entity    String
  entityId  String?  @map("entity_id")
  metadata  Json?
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user      User     @relation(fields: [userId], references: [id])

  @@map("audit_logs")
}
